pipeline {
    agent any
    stages {
        stage('Prepare machine for deployment'){
            steps{
                sh "sudo snap install microk8s --classic"

                sh "sudo apt install docker.io"

                sh "sudo usermod -a -G microk8s jenkins"

                sh "sudo mkdir ~/.kube"

                sh "sudo chown -f -R jenkins ~/.kube"

                sh "microk8s enable helm3"

            }
        }
        stage('Clone Repositories'){
            steps{
                sh "git clone -b keycloak https://github.com/thanbimp/Recommendation-Letter-Service.git"
            }
        }

        stage('Copy some files'){
            steps{
                sh "mv playbooks/files/application.properties Recommendation-Letter-Service/application.properties"

                sh "cp playbooks/files/keycloak_realm.json /home/jenkins/keycloak.json"
            }
        }

        stage ('Build application jar and image'){
            steps{

                sh "chmod +x Recommendation-Letter-Service/mvnw"

                sh "cd Recommendation-Letter-Service && ./mvnw package -DskipTests"

                sh "sudo chmod 666 /var/run/docker.sock"

                sh "cd Recommendation-Letter-Service && docker build ./ -t spring_boot_app"

            }
        }

        stage ('Deploy Kubernetes'){
            steps{
                sh "microk8s.kubectl apply -f playbooks/files/kubernetes/keycloak-claim0-persistentvolumeclaim.yaml"

                sh "microk8s.kubectl apply -f playbooks/files/kubernetes/keycloak-deployment.yaml"

                sh "microk8s.kubectl apply -f playbooks/files/kubernetes/keycloak-service.yaml"

                sh "microk8s.kubectl apply -f playbooks/files/kubernetes/local-keycloak-networkpolicy.yaml"

                sh "microk8s.kubectl apply -f playbooks/files/kubernetes/mysql-claim0-persistentvolumeclaim.yaml"

                sh "microk8s.kubectl apply -f playbooks/files/kubernetes/mysql-deployment.yaml"

                sh "microk8s.kubectl apply -f playbooks/files/kubernetes/mysql-service.yaml"

                sh "microk8s.kubectl apply -f playbooks/files/kubernetes/spring-boot-app-deployment.yaml"

                sh "microk8s.kubectl apply -f playbooks/files/kubernetes/spring-boot-app-service.yamll"

                sh "microk8s helm3 repo add codecentric https://codecentric.github.io/helm-charts && microk8s helm3 install mailhog codecentric/mailhog"

            }
        }
    }
}